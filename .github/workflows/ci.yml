name: CI

on: [push]

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        php: ['8.2']
        go: ['1.19']
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      - name: Install Go
        uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0
        with:
          go-version: ${{ matrix.go }}
          cache: true
      - name: Install scip
        run: |
          git clone https://github.com/sourcegraph/scip.git --depth=1
          cd scip
          go build -o scip ./cmd/scip
          mv scip /usr/local/bin/scip
      - name: Install PHP
        uses: shivammathur/setup-php@e6f75134d35752277f093989e72e140eaa222f35 # v2.28.0
        with:
          php-version: ${{ matrix.php }}
          coverage: xdebug
      - name: Validate composer
        run: composer validate --strict --check-lock --with-dependencies
      - name: Install dependencies
        run: composer install --no-interaction --no-progress
      - name: Test
        run: vendor/bin/phpunit --coverage-text --coverage-cobertura=coverage.xml --colors=never
        env:
          XDEBUG_MODE: coverage
      - name: Upload coverage
        uses: codecov/codecov-action@eaaf4bedf32dbdc6b720b63067d99c4d77d6047d # v3.1.4

  lint-phpcs:
    name: PHP CodeSniffer
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        php: ['8.2', '8.3']
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      - name: Install PHP
        uses: shivammathur/setup-php@e6f75134d35752277f093989e72e140eaa222f35 # v2.28.0
        with:
          php-version: ${{ matrix.php }}
          coverage: none
      - name: Validate composer
        run: composer validate --strict --check-lock --with-dependencies
      - name: Install dependencies
        run: composer install --no-interaction --no-progress
      - name: PHP CodeSniffer
        run: vendor/bin/phpcs --no-colors

  lint-phpstan:
    name: PHPStan
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        php: ['8.2']
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      - name: Install PHP
        uses: shivammathur/setup-php@e6f75134d35752277f093989e72e140eaa222f35 # v2.28.0
        with:
          php-version: ${{ matrix.php }}
          coverage: none
      - name: Validate composer
        run: composer validate --strict --check-lock --with-dependencies
      - name: Install dependencies
        run: composer install --no-interaction --no-progress
      - name: PHPStan
        run: vendor/bin/phpstan

  lint-composer-audit:
    name: Composer audit
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        php: ['8.2']
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      - name: Install PHP
        uses: shivammathur/setup-php@e6f75134d35752277f093989e72e140eaa222f35 # v2.28.0
        with:
          php-version: ${{ matrix.php }}
          coverage: none
      - name: Validate composer
        run: composer validate --strict --check-lock --with-dependencies
      - name: Audit
        run: composer audit --locked --no-interaction

  scip:
    name: SCIP
    needs: [test, lint-phpstan, lint-phpcs]
    if: github.repository == 'davidrjenni/scip-php'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      - name: Install PHP
        uses: shivammathur/setup-php@e6f75134d35752277f093989e72e140eaa222f35 # v2.28.0
      - name: Install dependencies
        run: composer install --no-interaction --no-progress
      - name: Generate SCIP data
        uses: davidrjenni/scip-php@main
        with:
          entrypoint: /usr/bin/scip-php
      - name: Upload SCIP index
        uses: davidrjenni/scip-php@main
        with:
          entrypoint: /usr/bin/src
          args: code-intel upload -repo=github.com/${{ github.repository }} -commit=${{ github.sha }} -root=${{ github.workspace }} -github-token=${{ secrets.GITHUB_TOKEN }}

  deploy:
    name: Build and push image
    needs: [scip]
    if: |
      github.repository == 'davidrjenni/scip-php' &&
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      - name: Login to Docker Hub
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: Login to GitHub container registry
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@dbef88086f6cef02e264edb7dbf63250c17cef6c # v5.5.0
        with:
          images: |
            davidrjenni/scip-php
            ghcr.io/davidrjenni/scip-php
      - name: Build and push
        uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # v5.1.0
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
